<!DOCTYPE html>
<html>
<head>
    <title>Ваш билет</title>
	<meta charset="utf-8" />
</head>
<body>
    <style>
        .main {
                display: flex;
                flex-direction: column;
                font-size: 22px;
                align-items: center;
        }
        div {
            padding-bottom: 15px;
        }
        .main div span {
            text-decoration: underline;
        }
    </style>    
    <div class="main">
        <span>БЛАНК ЭЛЕКТРОННОГО ПРОЕЗДНОГО ДОКУМЕНТА </span>
        <div id="number"> Номер заказа: </div>
        <div id="user"> ФИО: </div>
        <div id="direction">Направление:</div>
        <div>Отправление: <span id ="from">Минск 01.05.2017 16:30</span></div> 
        <div>Прибытие: <span "id"="to">Брест 01.05.2017 20:10</span></div>         
        <div>Вагон: <span id = "carriage">4 Плацкарт </span>Место: узнавайте у проводника</div>
    </div>  
    <script>
        (function setVal(){
            
            let train = getParameterByName("trainNumber");
            let from = getParameterByName("from");
            let to = getParameterByName("to");
            let carriage = getParameterByName("carriage");
            getData(train, from, to, carriage);          
        })()
        function getParameterByName(name) {
            let url = window.location.href;
             
            name = name.replace(/[\[\]]/g, "\\$&");
            let regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
        function getData(trainNumber, from, to, carriage){
            var xhr = new XMLHttpRequest();
            var body = JSON.stringify({
                trainNumber:trainNumber,
                from: from,
                to: to,
                carriageName: carriage
            });
            xhr.open("POST", '/api/trip', true)
            xhr.setRequestHeader('Content-Type', 'application/json')
            xhr.onreadystatechange = function() {
                if (xhr.readyState != 4) return;                
                if (xhr.status != 200) {
                    alert('error');
                } else {
                    fillHtml(JSON.parse(xhr.responseText));
                }
            }
            xhr.send(body);
        }
        function fillHtml(data){
            document.getElementById("user").innerText += ' '+getParameterByName('name');
            document.getElementById("carriage").innerText = getParameterByName('carriage') + ' ' + data.carriageType + ' ';
            let arr = data.direction.split(',');
            let direction = getParameterByName('trainNumber') + ' ' + arr[0] + ' - ' +arr[1];
            document.getElementById("direction").innerText += ' '+ direction;
            
            let time = new Date(data.from.arrive) + data.from.stayTime * 60000;
            let str = data.from.station.name + ' '+ time.getDate() + '.'+ time.getMonth()+1 + '.' + qwe.getFullYear() + ' ' + time.toTimeString();
            document.getElementById("from").innerText = str;
            time = new Date(data.to.arrive);
            str = data.to.station.name + ' '+ time.getDate() + '.'+ time.getMonth()+1 + '.' + qwe.getFullYear() + ' ' + time.toTimeString();
            document.getElementById("to").innerText = str;
            document.getElementById("number").innerText += Math.random().toString().substring(2,11);
        }
    </script>  
</body>
</html>
